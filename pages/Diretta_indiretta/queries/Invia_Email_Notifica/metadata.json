{
  "gitSyncId": "6601851cbf3e805bd6a4b13a_95ca3579-5ca0-404e-880b-4055651f3e24",
  "id": "Diretta_indiretta_Invia_Email_Notifica",
  "pluginId": "mssql-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "DECLARE @MailDestinatario NVARCHAR(255);\nDECLARE @MailSubject NVARCHAR(255);\nDECLARE @MailBody NVARCHAR(MAX);\nDECLARE @NomeUtente NVARCHAR(100);\nDECLARE @NumeroFattura NVARCHAR(50); -- Variabile per gestire il numero come testo\n\n-- Convertiamo subito il numero in testo per evitare errori\nSET @NumeroFattura = CAST({{ Input_Numero.text }} AS NVARCHAR(50));\n\n-- 1. Recupera email e nome\nSELECT TOP 1 \n    @MailDestinatario = info.UFDEFNOTMAIL,\n    @NomeUtente = u.name\nFROM dbo.cpusers AS u\nINNER JOIN dbo.ba_users_info AS info ON u.code = info.UFUSERID\nWHERE u.code = {{ Check_Stato_Utente.data[0].code }};\n\n-- 2. Costruisce Oggetto (Usa la variabile testo)\nSET @MailSubject = 'Notifica variazione fattura n. ' + @NumeroFattura;\n\n-- 3. Costruisce Corpo (Usa la variabile testo)\nSET @MailBody = 'È stata variata la fattura n. ' + @NumeroFattura + CHAR(13) + CHAR(10) +\n                'Nuova tipologia: ' + '{{ Select_Tipo.selectedOptionLabel }}' + CHAR(13) + CHAR(10) +\n                'Utente: ' + ISNULL(@NomeUtente, 'N/A') + ' (Codice: ' + CAST('{{ Check_Stato_Utente.data[0].code }}' AS NVARCHAR) + ')' + CHAR(13) + CHAR(10) +\n                'Data: ' + CONVERT(NVARCHAR, GETDATE(), 103) + ' ' + CONVERT(NVARCHAR, GETDATE(), 108);\n\n-- 4. Invia\nIF @MailDestinatario IS NOT NULL AND LEN(@MailDestinatario) > 0\nBEGIN\n    EXEC msdb.dbo.sp_send_dbmail\n        @profile_name = 'notifiche@cdcpaideia.com',\n        @recipients = @MailDestinatario,\n        @subject = @MailSubject,\n        @body = @MailBody;\nEND\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "TEST_PAIDEIA",
      "isAutoGenerated": false,
      "name": "TEST_PAIDEIA",
      "pluginId": "mssql-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Invia_Email_Notifica",
    "pageId": "Diretta_indiretta",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}