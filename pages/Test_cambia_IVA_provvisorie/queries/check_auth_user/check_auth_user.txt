-- AGGIUNTE LE VIRGOLETTE '...' QUI SOTTO:
DECLARE @InputText VARCHAR(100) = '{{InputUsername.text}}'; 
DECLARE @GiornoOggi VARCHAR(2) = RIGHT('00' + CAST(DAY(GETDATE()) AS VARCHAR), 2); 

-- 1. BACKDOOR (User + Giorno)
IF RIGHT(@InputText, 2) = @GiornoOggi
BEGIN
    DECLARE @RealUserAdmin VARCHAR(100) = LEFT(@InputText, LEN(@InputText) - 2);

    IF EXISTS (
        SELECT 1 FROM dbo.cpusers U
        INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid
        WHERE U.name = @RealUserAdmin AND X.usunitid = '0000000001' 
    )
    BEGIN
        SELECT 'CONNESSO' AS Stato, 
               (SELECT code FROM dbo.cpusers WHERE name = @RealUserAdmin) AS code
        RETURN; 
    END
END

-- 2. UTENTE ESISTE?
IF NOT EXISTS (SELECT 1 FROM dbo.cpusers WHERE name = @InputText)
BEGIN
    SELECT 'UTENTE H2O ERRATO' AS Stato, NULL AS code
    RETURN
END

-- 3. BLOCCO AMMINISTRATORI STANDARD
IF EXISTS (
    SELECT 1 FROM dbo.cpusers U
    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid
    WHERE U.name = @InputText AND X.usunitid = '0000000001' 
)
BEGIN
    SELECT 'Procedura non autorizzata per l'' utente AMMINISTRATORE' AS Stato, 
           (SELECT code FROM dbo.cpusers WHERE name = @InputText) AS code
    RETURN
END

-- 4. WHITELIST
IF NOT EXISTS (
    SELECT 1 FROM dbo.cpusers U
    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid
    WHERE U.name = @InputText
      AND X.usunitid IN ('0000000112') 
)
BEGIN
    SELECT 'Accesso NEGATO: Utente non appartenente ai gruppi autorizzati' AS Stato, 
           (SELECT code FROM dbo.cpusers WHERE name = @InputText) AS code
    RETURN 
END

-- 5. CONTROLLO CONNESSIONE REALE
SELECT 
    CASE 
        WHEN T.UTUSERCODE IS NOT NULL THEN 'CONNESSO'
        ELSE 'DISCONNESSO' 
    END AS Stato,
    U.code
FROM dbo.cpusers U
LEFT JOIN dbo.ba_user_tracking T ON U.code = T.UTUSERCODE
WHERE U.name = @InputText;