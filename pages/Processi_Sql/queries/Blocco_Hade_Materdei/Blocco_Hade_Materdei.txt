SELECT 
    Ses.session_id, 
    Ses.login_name AS utente,
    DB_NAME(Ses.database_id) AS nome_db,
    Ses.status AS stato,
    -- Mostra l'ID del colpevole
    Req.blocking_session_id AS blocking_id,
    ISNULL(Req.total_elapsed_time / 1000, 0) AS secondi_trascorsi,
    Req.wait_type AS motivo_attesa,
    CASE 
        WHEN ST.text IS NOT NULL THEN 
            SUBSTRING(ST.text, (Req.statement_start_offset/2) + 1,
            ((CASE Req.statement_end_offset
                WHEN -1 THEN DATALENGTH(ST.text)
                ELSE Req.statement_end_offset
            END - Req.statement_start_offset)/2) + 1)
        ELSE '--- In attesa ---' 
    END AS query_text
FROM 
    sys.dm_exec_sessions AS Ses
    JOIN sys.dm_exec_requests AS Req ON Ses.session_id = Req.session_id
    OUTER APPLY sys.dm_exec_sql_text(Req.sql_handle) AS ST
WHERE 
    Ses.session_id > 50             
    AND Ses.session_id <> @@SPID    
    AND Req.blocking_session_id > 0  -- <--- FILTRO: Prende solo chi Ã¨ bloccato (valore >= 1)