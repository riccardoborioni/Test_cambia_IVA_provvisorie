SELECT TOP 100
    I.INMYCOMPANYID,
    I.ININVOICEID,
    I.INPURPOSEID,
    I.INDOCUMENTTYPE,
    I.INCUSTOMERDESCRIPTION,
    I.INTAXYEAR,
    I.ININVOICENUMBER,
    I.ININVOICEDATE,
    MAX(D.INHOSPITALIZATIONID) as INHOSPITALIZATIONID,
    MAX(H.HOLASTNAME) as HOLASTNAME,
    MAX(H.HOHOSPCOUNTER) as HOHOSPCOUNTER, 
    MAX(P.DPPURPOSEDESCRIPTION) as DPPURPOSEDESCRIPTION

FROM ba_invoice_m I
LEFT JOIN ba_document_purpose P ON I.INPURPOSEID = P.DPPURPOSEID
LEFT JOIN ba_invoice D ON I.ININVOICEID = D.ININVOICEID
LEFT JOIN ba_hospitalization H ON D.INHOSPITALIZATIONID = H.HOHOSPID

WHERE I.INDOCUMENTTYPE IN ('FA', 'NC')
  AND (I.ININVOICESET IS NULL OR I.ININVOICESET = '')

  -- *** QUESTA È LA PARTE CHE RISOLVE IL TUO PROBLEMA ***
  AND (
        -- Cerca per CF: usa l'anno DELLA FATTURA, non della cartella
       (
           I.INCUFISCALCODE = '{{Input_CF.text}}' 
           AND '{{Input_CF.text}}' != ''
           AND ('{{Input_Anno.text}}' = '' OR I.INTAXYEAR = '{{Input_Anno.text}}')
       )
       OR 
       
       -- Cerca per Cartella solo se NON è vuota E controlla anche l'anno della cartella
       (
           H.HOHOSPCOUNTER = '{{Input_Cartella.text}}' 
           AND '{{Input_Cartella.text}}' != ''
           -- NUOVA RIGHE AGGIUNTE QUI SOTTO:
           AND H.HOHOSPYEAR = '{{Input_Anno.text}}'
       )
  )

  -- Filtro Anno (Opzionale per le fatture generali)
  AND (
       '{{Input_Anno.text}}' = '' 
       OR 
       I.INTAXYEAR = '{{Input_Anno.text}}'
  )

GROUP BY 
    I.INMYCOMPANYID,
    I.ININVOICEID,
    I.INPURPOSEID,
    I.INDOCUMENTTYPE,
    I.INCUSTOMERDESCRIPTION,
    I.INTAXYEAR,
    I.ININVOICENUMBER,
    I.ININVOICEDATE

ORDER BY I.ININVOICEDATE DESC;