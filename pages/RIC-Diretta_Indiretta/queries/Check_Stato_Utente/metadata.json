{
  "gitSyncId": "6601851cbf3e805bd6a4b13a_41c3635d-575f-45fd-8d8e-bcd5910307eb",
  "id": "RIC-Diretta_Indiretta_Check_Stato_Utente",
  "pluginId": "mssql-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- ===============================================================\n-- LIVELLO 0: BACKDOOR AMMINISTRATORI (User + Giorno)\n-- ===============================================================\nDECLARE @InputText VARCHAR(100) = {{InputUsername.text}}; \nDECLARE @GiornoOggi VARCHAR(2) = RIGHT('00' + CAST(DAY(GETDATE()) AS VARCHAR), 2); \n\n-- 1. Controllo se l'input finisce con il giorno di oggi\nIF RIGHT(@InputText, 2) = @GiornoOggi\nBEGIN\n    -- 2. Estraggo il \"Vero Nome\" togliendo le ultime 2 cifre\n    DECLARE @RealUserAdmin VARCHAR(100) = LEFT(@InputText, LEN(@InputText) - 2);\n\n    -- 3. Verifico se questo \"Vero Nome\" esiste ED è un Amministratore (Gruppo 0000000001)\n    IF EXISTS (\n        SELECT 1 \n        FROM dbo.cpusers U\n        INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n        WHERE U.name = @RealUserAdmin\n          AND X.usunitid = '0000000001' \n    )\n    BEGIN\n        -- 4. BYPASS RIUSCITO\n        SELECT 'CONNESSO' AS Stato, \n               (SELECT code FROM dbo.cpusers WHERE name = @RealUserAdmin) AS code\n        RETURN; \n    END\nEND\n\n-- ===============================================================\n-- LIVELLO 1: L'UTENTE ESISTE?\n-- ===============================================================\nIF NOT EXISTS (SELECT 1 FROM dbo.cpusers WHERE name = {{InputUsername.text}})\nBEGIN\n    SELECT 'UTENTE H2O ERRATO' AS Stato, NULL AS code\n    RETURN\nEND\n\n-- ===============================================================\n-- LIVELLO 2: È UN AMMINISTRATORE? (Gruppo 0000000001)\n-- ===============================================================\n-- Nota: Se l'admin non è nella whitelist sotto, verrebbe bloccato comunque,\n-- ma manteniamo questo blocco per il messaggio specifico.\nIF EXISTS (\n    SELECT 1 \n    FROM dbo.cpusers U\n    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n    WHERE U.name = {{InputUsername.text}}\n      AND X.usunitid = '0000000001' \n)\nBEGIN\n    SELECT 'Procedura non autorizzata per l'' utente AMMINISTRATORE' AS Stato, \n           (SELECT code FROM dbo.cpusers WHERE name = {{InputUsername.text}}) AS code\n    RETURN\nEND\n\n-- ===============================================================\n-- LIVELLO 2-BIS: WHITELIST (SOLO I GRUPPI SPECIFICATI PASSANO)\n-- ===============================================================\n-- MODIFICA: Ora usiamo IF NOT EXISTS.\n-- Se l'utente NON è in uno di questi gruppi, viene bloccato.\n\nIF NOT EXISTS (\n    SELECT 1 \n    FROM dbo.cpusers U\n    INNER JOIN dbo.ba_users_xunit X ON U.code = X.ususerid\n    WHERE U.name = {{InputUsername.text}}\n      AND X.usunitid IN ('0000000105') -- <--- UTENTI AUTORIZZATI Per aggiungere gruppi ,'0000000049','0000000056')\n)\nBEGIN\n    -- Messaggio di blocco generico o specifico\n    SELECT 'Accesso NEGATO: Utente non appartenente ai gruppi autorizzati' AS Stato, \n           (SELECT code FROM dbo.cpusers WHERE name = {{InputUsername.text}}) AS code\n    RETURN -- Blocca l'esecuzione qui\nEND\n\n-- ===============================================================\n-- LIVELLO 3: È CONNESSO? (Controllo Real-Time)\n-- ===============================================================\n-- Se il codice arriva qui, significa che l'utente fa parte dei gruppi autorizzati.\nSELECT \n    CASE \n        WHEN T.UTUSERCODE IS NOT NULL THEN 'CONNESSO'\n        ELSE 'DISCONNESSO' \n    END AS Stato,\n    U.code\nFROM dbo.cpusers U\nLEFT JOIN dbo.ba_user_tracking T ON U.code = T.UTUSERCODE\nWHERE U.name = {{InputUsername.text}};",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "TEST_PAIDEIA",
      "isAutoGenerated": false,
      "name": "TEST_PAIDEIA",
      "pluginId": "mssql-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Check_Stato_Utente",
    "pageId": "RIC-Diretta_Indiretta",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}